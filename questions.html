<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вопросы и ответы</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .question {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        .question-text {
            flex: 1;
            margin-bottom: 10px;
        }
        .answer, .model-answer {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 3px;
            display: none;
        }
        .answer.show, .model-answer.show {
            display: block;
        }
        button {
            margin: 5px 5px 5px 0;
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #333;
            background: white;
            border-radius: 3px;
        }
        button:hover {
            background: #f0f0f0;
        }
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        .delete-btn {
            background: #ffebee;
        }
        .add-btn {
            font-size: 20px;
            padding: 10px 20px;
            margin: 20px 0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            max-width: 600px;
            border-radius: 5px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal input, .modal textarea, .modal select {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            box-sizing: border-box;
        }
        .modal textarea {
            min-height: 100px;
            font-family: monospace;
        }
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .config-section {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .config-section input {
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="mode-toggle">
        <button onclick="toggleMode()">Режим: <span id="mode-text">Редактирование</span></button>
    </div>

    <div id="content"><div class="loading">Загрузка...</div></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Добавить вопрос</h2>
            <label>Категория:</label>
            <select id="category">
                <option value="good">ХОРОШИЕ ВОПРОСЫ</option>
                <option value="simple">ПРОСТЫЕ ВОПРОСЫ</option>
                <option value="needsWork">ВОПРОСЫ, ТРЕБУЮЩИЕ ДОРАБОТКИ</option>
            </select>
            <label>Вопрос:</label>
            <textarea id="question-text"></textarea>
            <label>Ответ (markdown):</label>
            <textarea id="answer-text"></textarea>
            <label>Ответ модели (markdown):</label>
            <textarea id="model-answer-text"></textarea>
            <button onclick="saveQuestion()">Сохранить</button>
            <button onclick="closeModal()">Отмена</button>
        </div>
    </div>

    <script>
        let isEditMode = true;
        let editingKey = null;
        let database = null;
        
        // Конфигурация Firebase - замените на свою!
        const firebaseConfig = {
            apiKey: "AIzaSyCAnPjFE2yhHcnOoaVo7Q0RJ1hA-F4GEDc",
            authDomain: "some-questions-econ.firebaseapp.com",
            databaseURL: "https://some-questions-econ-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "some-questions-econ",
            storageBucket: "some-questions-econ.firebasestorage.app",
            messagingSenderId: "367035246315",
            appId: "1:367035246315:web:3f66c9dcf58756e86080ae"
        };
        
        let localData = {
            good: [
                {
                    question: "Как работает рекурсия?",
                    answer: "Рекурсия - это когда **функция вызывает саму себя**. Важно наличие базового случая для остановки.",
                    modelAnswer: "Рекурсия работает через *стек вызовов*. Каждый вызов сохраняется до достижения базового случая."
                }
            ],
            simple: [
                {
                    question: "Что такое переменная?",
                    answer: "Переменная - это *именованное место в памяти* для хранения данных.",
                    modelAnswer: "Переменная хранит значение, которое можно изменять во время выполнения программы."
                }
            ],
            needsWork: [
                {
                    question: "Объясни квантовую физику",
                    answer: "Требуется более конкретный вопрос.",
                    modelAnswer: "Это очень широкая тема, нужно уточнить что именно интересует."
                }
            ]
        };

        // Инициализация Firebase при загрузке
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            console.log('Firebase initialized');
            
            // Слушаем изменения в базе
            database.ref('questions').on('value', (snapshot) => {
                console.log('Data received from Firebase');
                const data = snapshot.val();
                if (data) {
                    localData = data;
                    render();
                } else {
                    console.log('Database empty, uploading initial data');
                    // Если база пустая, загружаем начальные данные
                    database.ref('questions').set(localData).then(() => {
                        console.log('Initial data uploaded');
                        render();
                    });
                }
            }, (error) => {
                console.error('Firebase read error:', error);
                document.getElementById('content').innerHTML = '<div class="error">Ошибка чтения из Firebase: ' + error.message + '. Проверьте правила доступа в Firebase Console.</div>';
            });
        } catch (error) {
            console.error('Firebase init error:', error);
            document.getElementById('content').innerHTML = '<div class="error">Ошибка подключения к Firebase: ' + error.message + '</div>';
        }

        function initFirebase() {
            const config = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };

            try {
                firebase.initializeApp(config);
                database = firebase.database();
                useFirebase = true;
                document.getElementById('config-modal').style.display = 'none';
                
                // Слушаем изменения в базе
                database.ref('questions').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        localData = data;
                    }
                    render();
                });
            } catch (error) {
                alert('Ошибка подключения к Firebase: ' + error.message);
            }
        }

        function useLocalMode() {
            useFirebase = false;
            document.getElementById('config-modal').style.display = 'none';
            render();
        }

        function render() {
            const content = document.getElementById('content');
            content.innerHTML = '';

            const categories = [
                { key: 'good', title: 'ХОРОШИЕ ВОПРОСЫ' },
                { key: 'simple', title: 'ПРОСТЫЕ ВОПРОСЫ' },
                { key: 'needsWork', title: 'ВОПРОСЫ, ТРЕБУЮЩИЕ ДОРАБОТКИ' }
            ];

            categories.forEach(cat => {
                const section = document.createElement('div');
                section.innerHTML = `<h1>${cat.title}</h1>`;
                
                const items = localData[cat.key] || [];
                items.forEach((item, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    
                    questionDiv.innerHTML = `
                        <div class="question-header">
                            <div class="question-text">${escapeHtml(item.question)}</div>
                            ${isEditMode ? `
                                <div>
                                    <button class="edit-btn" onclick="editQuestion('${cat.key}', ${index})">✏️ Редактировать</button>
                                    <button class="delete-btn" onclick="deleteQuestion('${cat.key}', ${index})">🗑️ Удалить</button>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="toggleAnswer(this)">Показать ответ</button>
                        <div class="answer">${marked.parse(item.answer)}</div>
                        <button onclick="toggleModelAnswer(this)">Показать ответ модели</button>
                        <div class="model-answer">${marked.parse(item.modelAnswer)}</div>
                    `;
                    
                    section.appendChild(questionDiv);
                });

                if (isEditMode) {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-btn';
                    addBtn.textContent = '+ Добавить вопрос';
                    addBtn.onclick = () => openModal(cat.key);
                    section.appendChild(addBtn);
                }

                content.appendChild(section);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleAnswer(btn) {
            const answer = btn.nextElementSibling;
            answer.classList.toggle('show');
            btn.textContent = answer.classList.contains('show') ? 'Скрыть ответ' : 'Показать ответ';
        }

        function toggleModelAnswer(btn) {
            const answer = btn.nextElementSibling;
            answer.classList.toggle('show');
            btn.textContent = answer.classList.contains('show') ? 'Скрыть ответ модели' : 'Показать ответ модели';
        }

        function openModal(category) {
            document.getElementById('modal').style.display = 'block';
            document.getElementById('modal-title').textContent = 'Добавить вопрос';
            document.getElementById('category').value = category;
            document.getElementById('question-text').value = '';
            document.getElementById('answer-text').value = '';
            document.getElementById('model-answer-text').value = '';
            editingKey = null;
        }

        function editQuestion(category, index) {
            const item = localData[category][index];
            document.getElementById('modal').style.display = 'block';
            document.getElementById('modal-title').textContent = 'Редактировать вопрос';
            document.getElementById('category').value = category;
            document.getElementById('question-text').value = item.question;
            document.getElementById('answer-text').value = item.answer;
            document.getElementById('model-answer-text').value = item.modelAnswer;
            editingKey = `${category}-${index}`;
        }

        function saveQuestion() {
            const category = document.getElementById('category').value;
            const question = document.getElementById('question-text').value;
            const answer = document.getElementById('answer-text').value;
            const modelAnswer = document.getElementById('model-answer-text').value;

            if (!question || !answer || !modelAnswer) {
                alert('Заполните все поля');
                return;
            }

            if (!localData[category]) {
                localData[category] = [];
            }

            if (editingKey === null) {
                localData[category].push({ question, answer, modelAnswer });
            } else {
                const [cat, idx] = editingKey.split('-');
                localData[cat][idx] = { question, answer, modelAnswer };
            }

            if (database) {
                database.ref('questions').set(localData);
            }

            closeModal();
            render();
        }

        function deleteQuestion(category, index) {
            if (confirm('Удалить этот вопрос?')) {
                localData[category].splice(index, 1);
                
                if (database) {
                    database.ref('questions').set(localData);
                } else {
                    render();
                }
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function toggleMode() {
            isEditMode = !isEditMode;
            document.getElementById('mode-text').textContent = isEditMode ? 'Редактирование' : 'Демонстрация';
            render();
        }
    </script>
</body>
</html>
